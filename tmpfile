// inventoryFlow.js
// Inventory flow controller for Dicey Drinks

import { register, transitionTo } from '../stateMachine.js';
import { push, pop, peek, inventoryBack } from '../navigation.js';

let data = {};

// Update data reference (called from app.js when data changes)
export function setData(newData) {
    data = newData;
}

// Helper function to slugify strings
const slugify = (s) => s.toLowerCase().trim().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');

// Helper function to convert strings to title case
const toTitle = (s) => s.replace(/[_-]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

// Create the inventory flow states
function createInventoryStates() {
    // Render inventory landing page
    const renderLanding = (appContainer) => {
        let html = `
            <h2>Inventory</h2>
            <div class="inv-landing" style="display:flex; flex-direction:column; gap:12px; align-items:center;">
                <button id="view-inventory" class="primary">View Inventory</button>
                <button id="add-item" class="primary">Add Item</button>
                <button id="add-category" class="primary">Add Category</button>
            </div>
            <div style="position:fixed; bottom:16px; left:0; right:0; text-align:center;">
                <button id="export-inventory" class="secondary" style="opacity:0.9;">Export Inventory</button>
            </div>
            <div style="position:fixed; top:16px; left:16px;"><button id="back-to-idle">Back</button></div>
        `;
        appContainer.innerHTML = html;
        document.getElementById('back-to-idle').addEventListener('click', () => transitionTo('IDLE'));
        document.getElementById('export-inventory').addEventListener('click', () => window.exportInventory());
        document.getElementById('view-inventory').addEventListener('click', () => renderList(appContainer));
        document.getElementById('add-item').addEventListener('click', () => openAddModal());
        document.getElementById('add-category').addEventListener('click', () => openAddCategoryModal());
    };

    // Render inventory list page
    const renderList = async (appContainer) => {
        data = await window.getData();
        window.setData(data);
        const families = data.inventory.spirits.filter(s => s.type === 'family');
        const secondaryKeys = Object.keys(data.secondary || {});
        let html = `
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                <button id="inv-back" class="secondary">Back</button>
                <h2 style="margin:0;">Inventory</h2>
            </div>
            <div style="margin-bottom:10px; display:flex; gap:8px; align-items:center;">
                <input id="inv-search" type="text" placeholder="Searchâ€¦" style="flex:2; min-width:66%;">
                <select id="inv-filter" style="flex:1; min-width:25%;">
                    <option value="all">All</option>
                    ${families.map(f => `<option value="${f.subpool_id}">${f.name}</option>`).join('')}
                    <option value="mixers">Mixers</option>
                    <option value="additives">Additives</option>
                    ${secondaryKeys.map(k => `<option value="${k}">${(k.split('.')[1] || k)}</option>`).join('')}
                </select>
            </div>
            <div id="inv-list"></div>
        `;
        appContainer.innerHTML = html;
        const backBtn = document.getElementById('inv-back');
        const filterEl = document.getElementById('inv-filter');
        const searchEl = document.getElementById('inv-search');
        
        // Back navigates up one level: items -> categories, categories -> landing
        backBtn.addEventListener('click', () => {
            const backAction = inventoryBack({ 
                filter: filterEl.value, 
                query: searchEl.value 
            });
            
            if (backAction.action === 'goHome') {
                renderLanding(appContainer);
            } else {
                filterEl.value = backAction.filter;
                searchEl.value = backAction.query;
                renderItems(filterEl.value, searchEl.value.trim());
            }
        });

        const renderItemDetail = (ctx) => {
            const container = document.getElementById('inv-list');
            const { item, originKind, originId } = ctx;
            const faded = (on) => on ? '' : 'style="opacity:0.5"';
            container.innerHTML = `
                <div style="margin-bottom:8px;"><button id="detail-back" class="secondary">Back</button></div>
                <div ${faded(item.in_rotation)}>
                    <h3 style="margin:4px 0;">${item.name}</h3>
                    <button id="detail-toggle">${item.in_rotation ? 'Deprecate' : 'Restore'}</button>
                </div>
            `;
            document.getElementById('detail-back').addEventListener('click', () => {
                renderItems(filterEl.value, searchEl.value.trim());
            });
            document.getElementById('detail-toggle').addEventListener('click', async () => {
                item.in_rotation = !item.in_rotation;
                if (originKind === 'mixers' || originKind === 'additives') {
                    await window.updateItem(item);
                } else if (originKind === 'sub') {
                    await window.updateSubpoolItem(originId, item);
                } else if (originKind === 'sec') {
                    await window.updateSecondaryItem(originId, item);
                }
                data = await window.getData();
                window.setData(data);
                renderItemDetail({ item, originKind, originId });
            });
        };

        const renderItems = (filterVal, query) => {
            const container = document.getElementById('inv-list');
            const q = (query || '').toLowerCase();
            let out = '<ul style="list-style:none; padding:0;">';

            const pushItem = (obj) => {
                const isActive = obj.in_rotation !== false; // default true if missing
                const cls = isActive ? 'open-item' : 'open-item inv-deprecated';
                out += `<li><button class="${cls}" data-kind="${obj.kind}" data-origin="${obj.origin}" data-id="${obj.id}">${obj.name}</button></li>`;
            };

            if (q) {
                Object.keys(data.subpools || {}).forEach(sp => {
                    (data.subpools[sp] || []).forEach(it => {
                        if ((it.name || '').toLowerCase().includes(q)) pushItem({ kind: 'sub', origin: sp, id: it.id, name: it.name, in_rotation: it.in_rotation });
                    });
                });
                (data.inventory.mixers || []).forEach(m => {
                    if ((m.name || '').toLowerCase().includes(q)) pushItem({ kind: 'mixers', origin: 'mixers', id: m.id, name: m.name, in_rotation: m.in_rotation });
                });
                (data.inventory.additives || []).forEach(a => {
                    if ((a.name || '').toLowerCase().includes(q)) pushItem({ kind: 'additives', origin: 'additives', id: a.id, name: a.name, in_rotation: a.in_rotation });
                });
                Object.keys(data.secondary || {}).forEach(sk => {
                    (data.secondary[sk] || []).forEach(it => {
                        if ((it.name || '').toLowerCase().includes(q)) pushItem({ kind: 'sec', origin: sk, id: it.id, name: it.name, in_rotation: it.in_rotation });
                    });
                });
            } else if (filterVal === 'mixers') {
                (data.inventory.mixers || []).slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(m => pushItem({ kind: 'mixers', origin: 'mixers', id: m.id, name: m.name, in_rotation: m.in_rotation }));
            } else if (filterVal === 'additives') {
                (data.inventory.additives || []).slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(a => pushItem({ kind: 'additives', origin: 'additives', id: a.id, name: a.name, in_rotation: a.in_rotation }));
            } else if (filterVal && filterVal.startsWith('sub.')) {
                (data.subpools[filterVal] || []).slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(it => pushItem({ kind: 'sub', origin: filterVal, id: it.id, name: it.name, in_rotation: it.in_rotation }));
            } else if (filterVal && filterVal.startsWith('sec.')) {
                (data.secondary[filterVal] || []).slice().sort((a,b)=>a.name.localeCompare(b.name)).forEach(it => pushItem({ kind: 'sec', origin: filterVal, id: it.id, name: it.name, in_rotation: it.in_rotation }));
            } else {
                const categories = [
                    ...families.map(f => ({ id: f.subpool_id, label: f.name, kind: 'sub' })),
                    ...secondaryKeys.map(k => ({ id: k, label: toTitle(k.split('.')[1] || k), kind: 'sec' }))
                ].sort((a,b) => a.label.localeCompare(b.label));
                categories.forEach(c => {
                    out += `<li><button class="open-cat" data-id="${c.id}">${c.label}</button></li>`;
                });
            }

            out += '</ul>';
            container.innerHTML = out;

            container.querySelectorAll('.open-cat').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    filterEl.value = id;
                    // Navigating down a level: show items within this category
                    renderItems(id, '');
                });
            });
            container.querySelectorAll('.open-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const kind = e.currentTarget.getAttribute('data-kind');
                    const origin = e.currentTarget.getAttribute('data-origin');
                    let item = null;
                    if (kind === 'mixers' || kind === 'additives') {
                        item = (data.inventory[kind] || []).find(x => x.id === id);
                    } else if (kind === 'sub') {
                        item = (data.subpools[origin] || []).find(x => x.id === id);
                    } else if (kind === 'sec') {
                        item = (data.secondary[origin] || []).find(x => x.id === id);
                    }
                    if (item) {
                        renderItemDetail({ item: { ...item }, originKind: kind, originId: origin });
                    }
                });
            });
        };

        filterEl.addEventListener('change', () => {
            renderItems(filterEl.value, searchEl.value.trim());
        });
        searchEl.addEventListener('input', () => {
            renderItems(filterEl.value, searchEl.value.trim());
        });
        renderItems('all', '');
    };

    // Open add item modal
    const openAddModal = () => {
        const families = data.inventory.spirits.filter(s => s.type === 'family');
        const modal = document.createElement('div');
        modal.innerHTML = `
            <div id="add-item-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
                <div style="background:#222; padding:16px; border-radius:8px; width:90%; max-width:520px;">
                    <h3>Add Item</h3>
                    <label>Type:
                        <select id="new-type">
                            <option value="spirit">Spirit</option>
                            <option value="mixers">Mixer</option>
                            <option value="additives">Additive</option>
                        </select>
                    </label>
                    <div id="family-wrap" style="margin-top:8px; display:block;">
                        <label>Family:
                            <select id="new-family">
                                ${families.map(f => `<option value="${f.id}|${f.subpool_id}">${f.name}</option>`).join('')}
                            </select>
                        </label>
                    </div>
                    <label style="display:block; margin-top:8px;">Name: <input id="new-name" type="text" placeholder="e.g., Jim Beam"></label>
                    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
                        <button id="new-cancel">Cancel</button>
                        <button id="new-save" class="primary">Save</button>
                    </div>
                </div>
            </div>`;
        document.body.appendChild(modal.firstElementChild);

        const typeEl = document.getElementById('new-type');
        const famWrap = document.getElementById('family-wrap');
        const onTypeChange = () => {
            famWrap.style.display = typeEl.value === 'spirit' ? 'block' : 'none';
        };
        typeEl.addEventListener('change', onTypeChange);
        onTypeChange();

        document.getElementById('new-cancel').addEventListener('click', () => {
            document.getElementById('add-item-modal')?.remove();
        });
        document.getElementById('new-save').addEventListener('click', async () => {
            const t = typeEl.value;
            const name = (document.getElementById('new-name').value || '').trim();
            if (!name) return;

            if (t === 'spirit') {
                const val = document.getElementById('new-family').value; // e.g., spirits.whiskey|sub.whiskey
                const [familyId, subId] = val.split('|');
                const familyKey = familyId.split('.')[1];
                const id = `${familyKey}.${slugify(name)}`;
                const newItem = { id, name, in_rotation: true };
                await window.addSubpoolItem(subId, newItem);
            } else if (t === 'mixers') {
                const id = `mixers.${slugify(name)}`;
                const newItem = { id, name, in_rotation: true };
                await window.addItem(newItem);
            } else if (t === 'additives') {
                const id = `add.${slugify(name)}`;
                const newItem = { id, name, in_rotation: true };
                await window.addItem(newItem);
            }

            document.getElementById('add-item-modal')?.remove();
            const appContainer = document.getElementById('app-container');
            await renderList(appContainer);
        });
    };

    // Open add category modal
    const openAddCategoryModal = () => {
        const modal = document.createElement('div');
        modal.innerHTML = `
            <div id="add-category-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
                <div style="background:#222; padding:16px; border-radius:8px; width:90%; max-width:520px;">
                    <h3>Add Category</h3>
                    <label>Under:
                        <select id="cat-under">
                            <option value="spirit">Spirit</option>
                            <option value="secondary">Secondary</option>
                        </select>
                    </label>
                    <label style="display:block; margin-top:8px;">Name: <input id="cat-name" type="text" placeholder="e.g., Whiskey"></label>
                    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
                        <button id="cat-cancel">Cancel</button>
                        <button id="cat-save" class="primary">Save</button>
                    </div>
                </div>
            </div>`;
        document.body.appendChild(modal.firstElementChild);

        document.getElementById('cat-cancel').addEventListener('click', () => {
            document.getElementById('add-category-modal')?.remove();
        });
        document.getElementById('cat-save').addEventListener('click', async () => {
            const under = (document.getElementById('cat-under').value || 'spirit');
            const name = (document.getElementById('cat-name').value || '').trim();
            if (!name) return;
            if (under === 'spirit') {
                const key = slugify(name);
                const familyId = `spirits.${key}`;
                const subpoolId = `sub.${key}`;
                const familyItem = { id: familyId, name, type: 'family', in_rotation: true, subpool_id: subpoolId };
                await window.addItem(familyItem);
                await window.addSubpool(subpoolId, []);
            } else if (under === 'secondary') {
                const key = slugify(name);
                const poolId = `sec.${key}`;
                await window.addSecondaryPool(poolId, []);
            }
            document.getElementById('add-category-modal')?.remove();
            const appContainer = document.getElementById('app-container');
            await renderList(appContainer);
        });
    };

    // INVENTORY state
    return {
        enter: async () => {
            console.log('Entering INVENTORY state');
            const appContainer = document.getElementById('app-container');
            const panel = document.getElementById('dev-validations-panel');
            if (panel) panel.style.display = 'none';
            
            renderLanding(appContainer);
        },
        exit: () => {
            console.log('Exiting INVENTORY state');
        }
    };
}

// Register inventory flow states
export function registerInventoryFlowStates() {
    register('INVENTORY', createInventoryStates());
}
